// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  // Prisma ORM v7: cliente "no-rust" + driver adapter (recomendado).
  provider   = "prisma-client"
  engineType = "client"
  // Requerido por `prisma-client`. Lo generamos dentro de `src/` para que TS lo compile
  // sin errores de rootDir en Railway.
  // Ruta relativa a este directorio (`prisma/`).
  output     = "../src/generated/prisma"
}

datasource db {
  provider = "mysql"
}

model Device {
  id              String   @id @default(uuid())
  name            String
  number          String?
  status          String   @default("DISCONNECTED") // CONNECTED, DISCONNECTED, QR_READY, CONNECTING
  qr              String?
  lastUpdate      DateTime @updatedAt
  sessions        Message[]
  chats           Chat[]
  chatAliases     ChatAlias[]
}

model Chat {
  id              String   @id @default(uuid())
  deviceId        String
  device          Device   @relation(fields: [deviceId], references: [id])
  waChatId        String   // WhatsApp JID
  name            String?  // Nombre original de WhatsApp (pushName)
  customName      String?  // Nombre personalizado por el usuario (como si fuera la agenda)
  isGroup         Boolean  @default(false)
  unreadCount     Int      @default(0)
  priorityScore   Int      @default(0)
  lastMessageAt   DateTime @default(now())
  profilePhotoUrl String?
  messages        Message[]
  aliases         ChatAlias[]

  @@unique([deviceId, waChatId])
}

model ChatAlias {
  id        String   @id @default(uuid())
  deviceId  String
  device    Device   @relation(fields: [deviceId], references: [id])
  chatId    String
  chat      Chat     @relation(fields: [chatId], references: [id], onDelete: Cascade)
  waChatId  String
  createdAt DateTime @default(now())

  @@unique([deviceId, waChatId])
  @@index([deviceId, chatId])
}

model Message {
  id              String   @id @default(uuid())
  deviceId        String
  device          Device   @relation(fields: [deviceId], references: [id])
  chatId          String
  chat            Chat     @relation(fields: [chatId], references: [id])
  waMessageId     String   @unique
  fromMe          Boolean
  source          String   @default("whatsapp") // panel, whatsapp
  type            String   @default("text") // text, audio, image, video, document
  text            String?  @db.LongText
  mediaPath       String?
  timestamp       DateTime @default(now())
  status          String   @default("sent") // sent, delivered, read, failed
  rawJson         String?  @db.LongText
}

model RetentionPolicy {
  id              String   @id @default("global")
  daysMessages    Int      @default(30)
  daysFiles       Int      @default(30)
  enabled         Boolean  @default(true)
}
